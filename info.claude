# LoRaMINT

## 1 System Overview

IoT data collection service for LoRaWAN sensors.
Receives measurement data from The Things Network (TTN) via webhook, stores it in PostgreSQL.

Production: https://loramint.sfz-ox.de

### 1.1 Tech Stack

- Runtime: Bun
- Language: TypeScript (strict)
- Framework: Hono v4
- Validation: Zod v4
- Database: PostgreSQL (15 dev / 16 prod)
- API Docs: Scalar (OpenAPI)
- CI/CD: GitHub Actions -> GHCR (ghcr.io/loramint/loramint_docker)

### 1.2 Project Structure

```
index.ts           Main application, routes
config.ts          Environment variables (TTN_APP_KEY, PORT)
types.ts           TypeScript types + Zod schemas
migrate.ts         Database migration runner
services/
  measurement.ts   Measurement logic (validate, store, list, CSV export)
  log-entry.ts     Log entry logic (validate, store, list)
lib/
  openapi.ts       OpenAPI metadata
  pagination.ts    Pagination (max 100, default 20)
  validator.ts     Zod validation middleware
migrations/
  001-initial-schema.ts
scripts/
  entrypoints.sh   Docker entrypoint (migrate + start)
dev_scripts/
  test-webhook.sh  Webhook test script (sends sample data)
```

### 1.3 API Endpoints (/api/v1)

POST /webhook              TTN webhook (Header: X-Downlink-Apikey)
GET  /measurements         Paginated measurements
GET  /measurements/export  CSV export
GET  /log-entries           Paginated log entries
GET  /health                Health check
GET  /docs                  Interactive API docs

### 1.4 Database

measurements: id, device_eui, measurand, unit, datatype, sensor, location, value, time_method, recorded_at, created_at
log_entries:  id, device_eui, message, created_at

### 1.5 Environment Variables

Development (.env):
  DATABASE_URL=postgres://loramint:loramint@localhost:5432/loramint
  TTN_APP_KEY=<key>
  PORT=8090

Production (.env.prod):
  DB_NAME, DB_USER, DB_PASSWORD, TTN_APP_KEY

### 1.6 Development

docker compose -f compose.dev.yml up -d   # Start PostgreSQL
bun install                                # Install dependencies
bun run migrate                            # Run migrations
bun run dev                                # Start server with hot reload

### 1.7 Production

Image is built via GitHub Action (trigger: git tag v*).
compose.prod.yml pulls the image from GHCR.

### 1.8 Dockerfile

Multi-stage Bun build (oven/bun:1):
  1. base: Working directory
  2. install: Dependencies (frozen lockfile)
  3. release: App code + entrypoint
  Runs as user "bun", port 8090.

---

## 2 Chat Instructions

### 2.1 At the Start of Every Chat

- Ask the user which language to use for the conversation (German or English).

### 2.2 Key Decisions and Conventions

- Result pattern: Use `MutationResult<T>` for error handling, not exceptions.
- Validation: Zod for request structure, custom validation in services for business rules.
- Database: Use Bun's `sql` template tag, never string concatenation.
- Naming: camelCase in TypeScript, snake_case in database columns. Services handle the mapping.
- New endpoints: Add route in `index.ts`, business logic in `services/`, document with `describeRoute()`.
- New tables: Add migration file in `migrations/`, run `bun run migrate`.
- Dev scripts: Place in `dev_scripts/`.
